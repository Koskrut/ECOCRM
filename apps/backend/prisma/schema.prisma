// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// --- ENUMS ---

enum OrderStatus {
  NEW
  SHIPPING_CREATED
  SHIPPED
  DELIVERED
  CANCELED

  // NEW business statuses (добавляем)
  IN_WORK
  READY_TO_SHIP
  PAYMENT_CONTROL
  RETURNING
  SUCCESS
}



enum DeliveryMethod {
  PICKUP
  NOVA_POSHTA
}

enum PaymentMethod {
  FOP
  CASH
}

enum UserRole {
  ADMIN
  LEAD
  MANAGER
}

enum NpRecipientType {
  PERSON
  COMPANY
}

enum NpDeliveryType {
  WAREHOUSE
  POSTOMAT
  ADDRESS
}

enum Carrier {
  NOVA_POSHTA
}

enum ActivityType {
  COMMENT
  CALL
  MEETING
}

// --- MODELS ---

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  fullName     String
  passwordHash String
  role         UserRole @default(MANAGER)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Company {
  id        String   @id @default(cuid())
  name      String
  edrpou    String?
  taxId     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contacts   Contact[]
  orders     Order[]
  activities Activity[]
}

model Contact {
  id        String   @id @default(cuid())
  companyId String?
  firstName String
  lastName  String
  phone     String
  email     String?
  position  String?
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)

  // связь для Order.clientId (старое поле clientId в Order)
  ordersAsClient Order[] @relation("OrderClient")

  // связь для Order.contactId (поле для ТТН)
  ordersAsContact Order[] @relation("OrderContact")

  // профили доставки НП (несколько на контакт)
  shippingProfiles ContactShippingProfile[]

  activities Activity[]

  @@index([companyId])
}

model ContactShippingProfile {
  id        String  @id @default(cuid())
  contactId String
  label     String
  isDefault Boolean @default(false)

  recipientType NpRecipientType
  deliveryType  NpDeliveryType

  // PERSON fields
  firstName  String?
  lastName   String?
  middleName String?
  phone      String?

  // COMPANY fields
  companyName             String?
  edrpou                  String?
  contactPersonFirstName  String?
  contactPersonLastName   String?
  contactPersonMiddleName String?
  contactPersonPhone      String?

  // city
  cityRef  String?
  cityName String?

  // warehouse / postomat
  warehouseRef    String?
  warehouseNumber String?
  warehouseType   String?

  // address
  streetRef  String?
  streetName String?
  building   String?
  flat       String?

  // cached NP refs
  npCounterpartyRef  String?
  npContactPersonRef String?
  npAddressRef       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contact Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@index([contactId])
  @@index([contactId, isDefault])
}

model Product {
  id        String   @id @default(cuid())
  sku       String
  name      String
  unit      String
  basePrice Float
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items OrderItem[]
}

model Order {
  id          String @id @default(cuid())
  orderNumber String @unique
  companyId   String?

  // старое поле (если используешь как "клиент заказа")
  clientId String?

  // поле — контакт для ТТН
  contactId String?

  ownerId        String
  status         OrderStatus
  currency       String
  subtotalAmount Float
  discountAmount Float
  totalAmount    Float
  paidAmount     Float
  debtAmount     Float
  comment        String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  deliveryMethod DeliveryMethod?
  paymentMethod  PaymentMethod?
  deliveryData   Json?

  company Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)

  // Order.clientId -> Contact
  client Contact? @relation("OrderClient", fields: [clientId], references: [id], onDelete: SetNull)

  // Order.contactId -> Contact (для ТТН)
  contact Contact? @relation("OrderContact", fields: [contactId], references: [id], onDelete: SetNull)

  items         OrderItem[]
  statusHistory OrderStatusHistory[]
  activities    Activity[]

  ttns OrderTtn[]

  @@index([companyId])
  @@index([clientId])
  @@index([contactId])
  @@index([status])
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  productId String
  qty       Int
  price     Float
  lineTotal Float

  // ✅ кеш для частичных отправок
  qtyShipped Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  // ✅ связи с конкретными ТТН (частичная отгрузка)
  ttnItems OrderTtnItem[]

  @@unique([orderId, productId], name: "orderId_productId")
  @@index([orderId])
  @@index([productId])
}

model OrderStatusHistory {
  id         String       @id @default(cuid())
  orderId    String
  fromStatus OrderStatus?
  toStatus   OrderStatus
  changedBy  String
  reason     String?
  createdAt  DateTime     @default(now())

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([toStatus])
  @@index([createdAt])
}

model OrderTtn {
  id      String  @id @default(cuid())
  orderId String
  carrier Carrier @default(NOVA_POSHTA)

  documentNumber String
  documentRef    String?

  statusCode String?
  statusText String?

  cost                  Float?
  estimatedDeliveryDate DateTime?

  payloadSnapshot Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // ✅ позиции, которые уехали в этой ТТН
  items OrderTtnItem[]

  @@index([orderId])
  @@index([documentNumber])
  @@index([statusCode])
  @@index([updatedAt])
}

//
// ✅ строки отгрузки по TTN (частичная отгрузка)
//
model OrderTtnItem {
  id          String @id @default(cuid())
  ttnId       String
  orderItemId String
  qtyShipped  Int

  ttn       OrderTtn  @relation(fields: [ttnId], references: [id], onDelete: Cascade)
  orderItem OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([ttnId])
  @@index([orderItemId])
  @@unique([ttnId, orderItemId])
}

model Activity {
  id         String       @id @default(cuid())
  type       ActivityType
  title      String?
  body       String
  occurredAt DateTime?
  createdBy  String
  createdAt  DateTime     @default(now())

  orderId   String?
  contactId String?
  companyId String?

  order   Order?   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  contact Contact? @relation(fields: [contactId], references: [id], onDelete: Cascade)
  company Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([contactId])
  @@index([companyId])
  @@index([createdAt])
}

// ===== NP Catalog cache (daily sync) =====

model NpCity {
  ref                       String   @id
  description               String
  area                      String?
  areaDescription           String?
  region                    String?
  settlementTypeDescription String?
  isActive                  Boolean  @default(true)
  updatedAt                 DateTime @updatedAt

  @@index([description])
}

model NpWarehouse {
  ref             String   @id
  cityRef         String
  cityName        String
  number          String?
  description     String
  shortAddress    String?
  typeOfWarehouse String?
  isPostomat      Boolean  @default(false)
  isActive        Boolean  @default(true)
  updatedAt       DateTime @updatedAt

  @@index([cityRef])
  @@index([description])
  @@index([isPostomat])
}

model NpStreet {
  ref       String   @id
  cityRef   String
  street    String
  updatedAt DateTime @updatedAt

  @@index([cityRef])
  @@index([street])
}

// ===== NP Sender cache (singleton) =====

model NpSenderSettings {
  id String @id @default("default")

  cityRef      String
  warehouseRef String

  counterpartyRef  String
  contactPersonRef String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
