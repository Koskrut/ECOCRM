# CRM — PRD (MVP)
Версия: 1.0  
Дата: 2026-02-02  
Команда: Sales (10 менеджеров), Руководители (3)  
Документ: `docs/PRD.md`

---

## 0. Кратко о продукте
CRM для отдела продаж, где **Order (заказ)** — центральная сущность. Система позволяет:
- быстро создавать заказ с товарами
- создавать ТТН перевозчика из заказа (первая интеграция — Новая Почта)
- автоматически обновлять статусы заказов по событиям (ТТН/оплата/доставка)
- подтягивать оплаты из Privat24 и матчить их к заказам
- вести компании и контакты, открывать карточки в модальных окнах
- вести **таймлайн клиента**: звонки/встречи/заметки + системные события
- заложить основу для будущих приложений (клиентское и менеджерское)

---

## 1. Цели и метрики успеха
### 1.1 Цели MVP
1) Сократить время создания заказа и ТТН.  
2) Уменьшить ошибки и ручной труд при статусах/оплатах.  
3) Дать прозрачность работы менеджеров через таймлайн.

### 1.2 Метрики (MVP)
- P50 время создания заказа (с товарами): ≤ 2 мин
- P50 время создания ТТН из заказа: ≤ 1 мин
- Доля авто-матчинга оплат: ≥ 70% (после настройки правил)
- Доля заказов со статусом, соответствующим факту (ТТН/оплата): ≥ 95%
- У 90% клиентов есть хотя бы 1 Activity (звонок/встреча/заметка) за 14 дней

---

## 2. Роли и доступы (RBAC + row-level)
### 2.1 Роли
**SalesManager (Менеджер)**
- Видит и редактирует: свои Company/Client/Order/Shipment/Payment(только просмотр)/Activity
- Создает заказ, добавляет товары, создает ТТН
- Создает Activity: CALL / MEETING / NOTE
- Не изменяет справочники и правила автоматики
- Не делает ручные привязки оплат (только предложения/комментарии)

**TeamLead (Руководитель)**
- Видит данные всех менеджеров
- Может вручную менять статус заказа (с обязательной причиной)
- Разбирает оплаты (unmatched/ambiguous), делает ручные привязки
- Доступ к отчетам (MVP: базовые)
- Может управлять справочниками/правилами (если включено)

**Admin (опционально)**
- Управление пользователями/ролями, интеграциями, справочниками

### 2.2 Политика доступа
- По умолчанию менеджер видит только свои записи (owner_id = user_id).
- Руководитель видит все записи своей команды (или все компании — конфиг).
- Важно: все изменения пишутся в AuditLog.

---

## 3. Термины и глоссарий
- Company — компания/контрагент
- Client — контактное лицо (телефон/почта/роль), принадлежит Company
- Order — заказ (документ продажи)
- OrderItem — позиция заказа (товар/кол-во/цена)
- Shipment — доставка/отгрузка (включая ТТН)
- Payment — оплата (из Privat24 или ручная/импорт)
- Activity — действие менеджера (звонок/встреча/заметка) или системное событие (создан заказ, статус, ТТН, оплата)
- StatusHistory — история переходов статусов
- IntegrationEvent — входящее событие интеграции (идемпотентность/ретраи)

---

## 4. Сущности и поля (MVP)
Ниже минимально-необходимые поля. Дополняются по мере уточнения.

### 4.1 Company
- id (UUID)
- name
- edrpou / tax_id (опц.)
- default_manager_id (owner)
- tags (опц.)
- created_at, updated_at

### 4.2 Client
- id
- company_id
- full_name
- phone
- email (опц.)
- position (опц.)
- is_primary (bool)
- created_at, updated_at

### 4.3 Product
- id
- sku
- name
- unit
- base_price
- is_active
- created_at, updated_at

### 4.4 Order
- id
- order_number (человекочитаемый)
- company_id
- client_id
- owner_id (менеджер)
- status (OrderStatus)
- currency (UAH по умолчанию)
- subtotal_amount
- discount_amount
- total_amount
- paid_amount (денормализовано)
- debt_amount (computed/denorm)
- comment (опц.)
- created_at, updated_at

### 4.5 OrderItem
- id
- order_id
- product_id
- qty
- price
- line_total

### 4.6 Shipment
- id
- order_id
- carrier (enum: NOVA_POSHTA; future: ...)
- status (ShipmentStatus)
- ttn_number (уникальный в рамках carrier)
- shipping_cost (опц.)
- recipient_name
- recipient_phone
- delivery_type (branch/address)
- branch_id / address_text
- payer (sender/recipient)
- cod_amount (наложка) (опц.)
- raw_payload (json, опц.)
- created_at, updated_at

### 4.7 Payment
- id
- source (PRIVAT24 | MANUAL)
- status (PaymentStatus)
- amount
- currency
- paid_at (время транзакции)
- transaction_id (уникальный по source)
- sender_name (опц.)
- sender_phone (опц.)
- description (назначение платежа)
- matched_order_id (опц.)
- match_confidence (0..100)
- raw_payload (json, опц.)
- created_at, updated_at

### 4.8 Activity (таймлайн)
- id
- type (CALL | MEETING | NOTE | SYSTEM)
- owner_id (кто создал; для SYSTEM = null/system)
- company_id (опц.)
- client_id (опц.)
- order_id (опц.)
- subject
- description (опц.)
- outcome (опц., enum/строка)
- start_at (опц.)
- end_at (опц.)
- call_duration_sec (опц.)
- next_step_at (опц.)
- created_at

### 4.9 StatusHistory (минимум)
- id
- entity_type (ORDER | SHIPMENT | PAYMENT)
- entity_id
- from_status
- to_status
- changed_by (user_id | SYSTEM)
- reason (обязательно для ручной смены руководителем)
- created_at

### 4.10 IntegrationEvent (минимум)
- id
- integration (NOVA_POSHTA | PRIVAT24)
- event_type (PAYMENT_RECEIVED | SHIPMENT_STATUS | ...)
- external_id (для идемпотентности)
- payload (json)
- status (RECEIVED | PROCESSED | FAILED)
- attempts
- last_error (опц.)
- created_at, updated_at

---

## 5. Статусы и правила (state machine)
### 5.1 OrderStatus (MVP)
- DRAFT — черновик (опц., если нужен)
- NEW — заказ создан
- SHIPPING_CREATED — создана ТТН
- PAID_PARTIAL — частично оплачен
- PAID — полностью оплачен
- SHIPPED — отправлен/принят перевозчиком
- DELIVERED — доставлен/получен
- CANCELLED — отменен

### 5.2 ShipmentStatus (MVP)
- CREATED — создано (ТТН есть)
- IN_TRANSIT — в пути
- DELIVERED — доставлено
- RETURNED / FAILED (опц.)

### 5.3 PaymentStatus (MVP)
- RECEIVED — получено из интеграции/введено
- MATCHED — привязано к заказу
- NEEDS_REVIEW — на разбор
- REJECTED (опц.)

### 5.4 Таблица переходов OrderStatus (основные)
| Триггер | From | To | Кто | Примечание |
|---|---|---|---|---|
| Создан заказ | (—) | NEW | Manager | Пишем Activity SYSTEM |
| Создана ТТН | NEW/PAID_PARTIAL/PAID | SHIPPING_CREATED | Manager/System | Авто при успешном ответе API |
| Пришла оплата (часть) | NEW/SHIPPING_CREATED | PAID_PARTIAL | System | Если paid_amount < total |
| Пришла оплата (полная) | NEW/SHIPPING_CREATED/PAID_PARTIAL | PAID | System | Если paid_amount >= total |
| Статус доставки “в пути” | SHIPPING_CREATED | SHIPPED | System | Если получаем из НП |
| Статус доставки “доставлено” | SHIPPED | DELIVERED | System | Если получаем из НП |
| Ручная отмена | * | CANCELLED | TeamLead | Обязательная причина |

**Правило:** любое изменение статуса → запись в StatusHistory + Activity (SYSTEM).

---

## 6. Ключевые сценарии (MVP)
### 6.1 Набивание заказа
**Шаги:**
1) Менеджер открывает список заказов → “Создать заказ”
2) Выбирает Company/Client (поиск) или создает “на лету” в модалке
3) Добавляет товары: поиск → qty → цена (автоподстановка базовой)
4) Сохраняет заказ
5) Видит карточку заказа: сумма, статусы, оплаты, доставка, таймлайн

**Требования:**
- поиск товаров и клиентов быстрый (debounce, индексы)
- пересчет сумм на лету
- сохранение атомарно (Order + Items)

### 6.2 Создание ТТН из заказа (Новая Почта)
**Шаги:**
1) В карточке заказа кнопка “Создать ТТН”
2) Форма доставки: получатель/телефон/тип доставки (отделение/адрес)/плательщик/наложка (опц.)
3) Отправка запроса в API НП
4) При успехе: Shipment создан, ттн_number записан
5) OrderStatus → SHIPPING_CREATED
6) В таймлайн: SYSTEM “Создана ТТН №...”

**Требования:**
- валидация обязательных полей до вызова API
- обработка ошибок API понятным текстом
- идемпотентность: повторное создание не должно создавать дубль (если уже есть Shipment с ттн)

### 6.3 Автоматические статусы и история
- Статус меняется только через “сервис статусов” (единая точка)
- Сервис всегда пишет StatusHistory
- Сервис всегда пишет Activity (SYSTEM)

### 6.4 Привязка оплат Privat24
**Получение оплат:**
- Вариант A: webhook
- Вариант B: polling (каждые N минут) — если webhook недоступен

**Процесс:**
1) Приходит транзакция → создаем Payment (idempotent по transaction_id)
2) Матчим к заказу
3) Если match_confidence >= threshold → matched_order_id + PaymentStatus= MATCHED
4) Иначе → PaymentStatus= NEEDS_REVIEW и попадает в очередь руководителю
5) При привязке обновляем paid_amount, меняем OrderStatus (PAID/PARTIAL) + история + таймлайн

---

## 7. Матчинг оплат (MVP-правила)
### 7.1 Источники сигналов
- order_number в назначении платежа (самый сильный)
- сумма (точное равенство или допуск)
- телефон/имя отправителя, совпадение с Client/Company
- временная близость к созданию заказа (например ±14 дней)

### 7.2 Уровни уверенности
- 90–100: exact (order_number найден) → авто
- 70–89: strong (сумма + телефон/компания) → авто (после согласования бизнеса)
- <70: needs_review

### 7.3 Очередь “На разбор”
Интерфейс для руководителя:
- список оплат NEEDS_REVIEW
- быстрый поиск заказа
- привязать/отклонить/комментарий
- логика: одна оплата может покрывать несколько заказов? (в MVP: **нет**, 1:1, если нужно — отдельное решение)

---

## 8. Таймлайн клиента (звонок/встреча/заметка)
### 8.1 Действия менеджера
**CALL**
- кнопка “Звонок”
- поля: outcome, заметка, длительность (или старт/стоп), next_step_at (опц.)
- сохраняется Activity(type=CALL)

**MEETING**
- кнопка “Встреча”
- поля: start_at/end_at, место/формат, outcome, заметка, next_step_at
- Activity(type=MEETING)

**NOTE**
- быстрая заметка в таймлайне

### 8.2 Системные события (SYSTEM)
- создан заказ
- изменен статус
- создана ТТН / обновлен статус доставки
- получена оплата / привязана оплата / ошибка матчинга

---

## 9. Экраны (MVP)
1) Login
2) Orders List
   - фильтры: статус, менеджер (для TL), период, поиск по номеру/компании/телефону
3) Order Card (модалка или страница)
   - товары, суммы, статус, доставка, оплаты, таймлайн
4) Company/Client Card (модалка)
   - контакты, последние заказы, таймлайн, быстрые действия CALL/MEETING
5) Payments Review (для TL)
   - список NEEDS_REVIEW, панель привязки к заказу
6) Products (справочник) — если включено в MVP

---

## 10. Нефункциональные требования
### 10.1 Производительность
- список заказов: пагинация + индексы
- поиск: по order_number, company.name, client.phone, ttn_number, payment.transaction_id
- цель: TTFB списка заказов < 500мс (при нормальной нагрузке)

### 10.2 Надежность интеграций
- идемпотентность входящих событий (IntegrationEvent.external_id / Payment.transaction_id)
- ретраи при ошибках (attempts, backoff)
- логирование запрос/ответ (без чувствительных данных)
- мониторинг ошибок интеграций (таблица/экран для TL/Admin — опц. в MVP)

### 10.3 Аудит и безопасность
- AuditLog: кто/что/когда изменил (Order/Payment/Shipment/Directory)
- StatusHistory обязателен
- RBAC + row-level security
- хранение токенов интеграций в защищенном хранилище

---

## 11. Вне MVP (не делать сейчас)
- клиентское приложение
- менеджерское мобильное приложение (визиты/гео)
- BI/сложные отчеты
- складской учет
- много-валютность (если не нужно прямо сейчас)
- поддержка 1 payment → N orders и наоборот (если не критично)

---

## 12. Открытые вопросы
1) Финальный список статусов заказов (DOMAIN.md): нужны ли “CONFIRMED”, “PACKED”, “RETURNED”?
2) Privat24: webhook доступен? если нет — частота polling и лимиты
3) Новая Почта: точный набор обязательных полей для ТТН (отделение/адрес/плательщик/наложка/оценочная стоимость)
4) Правило: можно ли создавать несколько Shipment на один Order (частичные отгрузки)? (в MVP: **нет**, 1:1)
5) Нужна ли скидка/наценка на уровне позиции или только на заказ? (в MVP: можно только на заказ)

---

## 13. Приложения
### 13.1 Минимальные бизнес-правила
- Order.total_amount = сумма позиций - скидка
- Order.paid_amount = сумма MATCHED оплат
- Order.debt_amount = max(total - paid, 0)
- статус оплаты:
  - если paid == 0 → NEW/SHIPPING_CREATED
  - 0 < paid < total → PAID_PARTIAL
  - paid >= total → PAID

### 13.2 Definition of Done (MVP)
- Менеджер создает заказ и ТТН без участия руководителя
- Оплаты подтягиваются и минимум 70% матчится автоматически (после настройки)
- Руководитель видит очередь на разбор и может быстро привязать оплату
- Таймлайн у клиента отражает звонки/встречи/системные события
- Все изменения статусов попадают в историю
